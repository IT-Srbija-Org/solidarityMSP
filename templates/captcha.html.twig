{% if show_captcha() %}
    <div>
        <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" defer></script>
        <div class="cf-turnstile"
             data-sitekey="{{ CLOUDFLARE_TURNSTILE_SITEKEY }}"
             data-theme="light"
             data-appearance="interaction-only"
             data-retry="auto"
             data-callback="onTurnstileSuccess"
        ></div>
    </div>

    <script>
        var turnstileReady = false;
        var pendingForm = null;

        function onTurnstileSuccess(token) {
            turnstileReady = true;
            if (pendingForm) {
                pendingForm.submit();
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            var widget = document.querySelector('.cf-turnstile');
            if (!widget) return;

            var form = widget.closest('form');
            if (!form) return;

            form.addEventListener('submit', function (e) {
                if (turnstileReady) return;

                e.preventDefault();
                pendingForm = form;

                var btn = form.querySelector('[type="submit"]');
                if (btn) {
                    btn.disabled = true;
                    btn.dataset.originalText = btn.textContent;
                    btn.textContent = 'Molimo saƒçekajte...';
                }
            });
        });
    </script>
{% endif %}
